
- [如何制作简易的debian包](#如何制作简易的debian包)
  - [Step1: 先创建如下文件夹](#step1-先创建如下文件夹)
  - [Step2: 在mips64el环境上编译airscan](#step2-在mips64el环境上编译airscan)
  - [Step3: 将二进制文件拷贝到/etc或usr下面](#step3-将二进制文件拷贝到etc或usr下面)
- [从源中下载Source然后编译](#从源中下载source然后编译)
  - [Step1: Create patch](#step1-create-patch)
  - [Step2: 从源中取得代码](#step2-从源中取得代码)
  - [Step3: 打上patch](#step3-打上patch)
  - [Step4: 修改changelog文件](#step4-修改changelog文件)
  - [Step5: 编译](#step5-编译)
- [从Alexander的站点下载文件然后编译](#从alexander的站点下载文件然后编译)
  - [Step1: 解压源代码](#step1-解压源代码)
  - [Step2: 打上你喜欢的补丁](#step2-打上你喜欢的补丁)
  - [Step3: 编译](#step3-编译)
- [自己制作创建debian文件夹](#自己制作创建debian文件夹)
  - [Step1: 安装编译需要的package](#step1-安装编译需要的package)
  - [Step2: 从github上下载源代码并解压](#step2-从github上下载源代码并解压)
  - [Step3: 生成debian目录和orig.tar.gz文件](#step3-生成debian目录和origtargz文件)
  - [Step4: 编辑debian文件夹下的文件](#step4-编辑debian文件夹下的文件)
  - [Step5: 打上patch](#step5-打上patch)
  - [Step6: 编译](#step6-编译)



+ https://www.debian.org/doc/manuals/debmake-doc/index.en.html<br>
+ https://www.debian.org/doc/manuals/maint-guide/index.en.html<br>

<br>

# 如何制作简易的debian包
最初编译mips64el版本的airscan debian包，是通过制作简易debian包来完成的，比较费手。

## Step1: 先创建如下文件夹

将airscan的library放入到etc/usr文件夹下面
```
DEBIAN
|--conffiles
|--control
|--md5sums
etc
usr
```

## Step2: 在mips64el环境上编译airscan
## Step3: 将二进制文件拷贝到/etc或usr下面
记得要重新生成文件的md5码
```
md5sum file
dpkg-deb -b package-name
```

# 从源中下载Source然后编译
随着Ubuntu21.04, Debian10将airscan放入到源中，我们可以直接从源中下载好代码，然后打上patch后重新编译。

## Step1: Create patch
```
$diff -uN folderA folderB > sample.patch
```
## Step2: 从源中取得代码
```
sudo apt-cache showsrc xxx		//查询是否有该source
apt-get source xxx			//获得source
sudo apt-get build-dep xxx		//获得source需要的依赖库
```
让我们来看看下载的source文件结构
|  |  | 
| -- | :-- | 
|sane-airscan-0.99.25|代码，= 源代码 + debian子文件夹|
|sane-airscan_0.99.25.orig.tar.gz|源代码的压缩格式|
|sane-airscan_0.99.25-0ubuntu1.debian.tar.xz|debian子文件夹的压缩格式|
|sane-airscan_0.99.25-0ubuntu1.dsc|dsc是"Debian Source Control的首字母缩写"。<br>Debian source .dsc file describes a source package. <br>This file contains a series of fields, identified and separated just like the fieilds in the control file of a binary package. <br>The Debian source control file is generated by dpkg-source when it builds the source archive, from other files in the source package, described above. When unpacking, it is checked against the files and directories in the other parts of the source package. <br>ref: https://wiki.debian.org/dsc|


<br>Notes: 将文件sane-airscan_0.99.25.orig.tar.gz 删除后调用dpkg-buildpackage会报如下错误, 但是将sane-airscan_0.99.25-0ubuntu1.debian.tar.xz & sane-airscan_0.99.25-0ubuntu1.dsc删除的话没有影响。
```
dpkg-source: error: can't build with source format '3.0 (quilt)': no upstream tarball found at ../sane-airscan_0.99.25.orig.tar.{bz2,gz,lzma,xz}
dpkg-buildpackage: error: dpkg-source -b . subprocess returned exit status 255
```
## Step3: 打上patch
```
cd sane-airscan-0.99.25
quilt import sample.patch
quilt push
quilt refresh
```
## Step4: 修改changelog文件
```
dch -n "Apply sample.patch"	 //dch工具在devscript包中
```
## Step5: 编译
```
fakeroot dpkg-buildpackage -us -uc
```
运行该命令build后又会在父目录上生成以下文件
|  |  | 
| -- | :-- | 
|sane-airscan_0.99.25-0ubuntu1_amd64.deb|编译产生的deb安装包|
|sane-airscan_0.99.25-0ubuntu1_amd64.buildinfo|一些build information|
|sane-airscan_0.99.25-0ubuntu1.debian.tar.xz| debian文件夹的压缩格式|
|sane-airscan_0.99.25-0ubuntu1.dsc| dsc file|
|sane-airscan-dbgsym_0.99.25-0ubuntu1_amd64.ddeb| debug symbol文件|

<br>

# 从Alexander的站点下载文件然后编译
这一方法是下载如下文件，然后编译

|  |  | 
| -- | :-- | 
|sane-airscan_0.99.26.orig.tar.gz|源代码|
|sane-airscan_0.99.26-1+86.6.dsc|包含了一些编译过程和Debian包所需要的一些信息，包括包名，版本号，生成包的名称等|
|sane-airscan_0.99.26-1+86.6.diff.gz|Debian为了编译.deb包而对源代码所作的修定，有时还可能包括一些对功能的改进或对Bug的修改等。最主要的，这个补丁会在源代码目录中增加一个包含了如何生成Debian发布包信息的目录，目录名称debian.|

<br>

## Step1: 解压源代码
将源代码解开到目录sane-airscan_0.99.26中，并打上debian补丁包。
```
dpkg-source -x sane-airscan_0.99.26-1+86.6.dsc
```

## Step2: 打上你喜欢的补丁
## Step3: 编译
```
fakeroot dpkg-buildpackage -b(只生成二进制包) -us -uc
```

# 自己制作创建debian文件夹
Ubuntu21.04能下载到的版本是0.99.25，但是Github上最新代码的版本是0.99.26. 如果要编译最新的Source看来需要自己制作debian子文件夹了。
## Step1: 安装编译需要的package
```
sudo apt install build-essential
```

## Step2: 从github上下载源代码并解压 
```
tar -zxvf sane-airscan-099.19.tar.gz
```
解压后的目录
```
sane-airscan-0.99.19
sane-airscan-0.99.19.tar.gz
```

## Step3: 生成debian目录和orig.tar.gz文件
```
cd sane-airscan0.99.19
dh_make -f ../sane-airscan-0.99.19.tar.gz
```
这一步会让你选择package的类型
```
Type of package: (single, indep, library, python), 一般来说，大部分情况下我们都是为了创建一个单独的二进制软件包，所以选择"s", 其他类型更为复杂，详细信息请查看dh_make的相关文档。
```
运行这一步后目录如下，多了一个debian子目录：
```
sane-airscan-0.99.19
|----debian
sane-airscan-0.99.19.orig.tar.gz
sane-airscan.tar.gz
```
查看debian子目录的，你会发现一下子多个很多文件，这些都是dh_make生成的，可以根据你需要打包的情况，修改control文件，rules文件。我一般都是将.ex文件全部删除掉。为了记录每次修改源的记录，建议修改changelog文件。 
```
$ ls -l
total 88
-rw-rw-r-- 1 tess tess   183 Jul  2 01:33 changelog
-rw-rw-r-- 1 tess tess   527 Jul  2 01:33 control
-rw-rw-r-- 1 tess tess  1900 Jul  2 01:33 copyright
-rw-rw-r-- 1 tess tess  1642 Jul  2 01:33 manpage.1.ex
-rw-rw-r-- 1 tess tess  4647 Jul  2 01:33 manpage.sgml.ex
-rw-rw-r-- 1 tess tess 11011 Jul  2 01:33 manpage.xml.ex
-rw-rw-r-- 1 tess tess   963 Jul  2 01:33 postinst.ex
-rw-rw-r-- 1 tess tess   936 Jul  2 01:33 postrm.ex
-rw-rw-r-- 1 tess tess   696 Jul  2 01:33 preinst.ex
-rw-rw-r-- 1 tess tess   883 Jul  2 01:33 prerm.ex
-rw-rw-r-- 1 tess tess   174 Jul  2 01:33 README.Debian
-rw-rw-r-- 1 tess tess   259 Jul  2 01:33 README.source
-rwxr-xr-x 1 tess tess   678 Jul  2 01:33 rules
-rw-rw-r-- 1 tess tess   535 Jul  2 01:33 salsa-ci.yml.ex
-rw-rw-r-- 1 tess tess   146 Jul  2 01:33 sane-airscan.cron.d.ex
-rw-rw-r-- 1 tess tess   570 Jul  2 01:33 sane-airscan.doc-base.EX
-rw-rw-r-- 1 tess tess    28 Jul  2 01:33 sane-airscan-docs.docs
drwxr-xr-x 2 tess tess  4096 Jul  2 01:33 source
-rw-rw-r-- 1 tess tess  1194 Jul  2 01:33 watch.ex
```

Notes：若一不小心把debian下的模板玩坏了，可以使用dh_make --addmissing参数来还原

## Step4: 编辑debian文件夹下的文件
|  |  | 
| -- | :-- | 
|control文件|需要维护build-dep信息，可以用命令$objdump -p libsane-airscan.so | grep NEEDED来查看需要哪些依赖库|
|copyright||
|changelog|若打了patch的话，建议修改一下dch -n "Apply test.patch"|
|rules|某些Unbuntu系统某人的压缩是control.tar.zst, 可以在rule文件中重新指定压缩方式override_dh_builddeb:\r\tdh_builddeb -- -Zxz|

## Step5: 打上patch
## Step6: 编译
```
fakeroot dpkg-buildpackage -b(只生成二进制包) -us -uc
```

